# S3 Stage Report

## 需求确认

- 本 Stage 目标：将认证与用户模块从硬编码内存数据迁移到数据库，覆盖 `/api/auth/wechat/login`、`/api/auth/bind-phone`、`/api/users/me` 的真实读写。
- 本 Stage 边界（不做）：不实现 S4 订单落库与事务化；订单模块仍为内存存储，仅复用 S3 的用户登录态解析能力。

## 代码改动

- 主要改动文件：
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/user/persistence/UserEntity.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/user/persistence/UserProfileEntity.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/user/persistence/UserRepository.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/user/persistence/UserProfileRepository.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/auth/AuthTokenService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/common/exception/BusinessException.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/user/UserService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/OrderService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/auth/AuthService.java`
  - `sunflower-backend/src/test/java/com/sunflower/backend/MvpApiIntegrationTests.java`
  - `docs/API.md`
  - `docs/API-Schemas.md`
  - `docs/Backlog.md`
- 关键实现点：
  - 新增 `users`、`user_profiles` 的 JPA 实体与仓库，用户信息改为数据库事实源。
  - `AuthService.wechatLogin` 按 `openid` 查找或自动创建用户与资料，返回可解析 `userId` 的 token。
  - 新增 `AuthTokenService`，支持从 `Authorization: Bearer <token>` 解析 userId。
  - `UserService` 移除 `DEMO_USER_ID` 与内存 `Map`，改为数据库查询与更新（资料更新、绑定手机号、手机号冲突保护）。
  - 鉴权热修：未携带 token 返回 `40100/请先登录`，token 格式无效返回 `40100/登录态无效`，不再回退到“首个活跃用户”。
  - 补充集成测试，覆盖登录/绑手机号/更新资料、非法参数、不存在用户、缺失/无效 token 场景。

## 自动化测试

- 执行命令：
  - `cd sunflower-backend && mvn test -Dtest=MvpApiIntegrationTests`
  - `cd sunflower-backend && mvn test`
- 结果：
  - 两条命令均通过。
  - `MvpApiIntegrationTests`：8/8 通过。
  - 全量测试：11/11 通过。

## 人工复核步骤

1. 启动后端（`dev` 配置），确认数据库中已有 `users` 与 `user_profiles` 数据。  
2. 调用 `POST /api/auth/wechat/login`（如 `code=mvp_code`），记录返回 `token`。  
3. 携带 `Authorization: Bearer <token>` 调用 `POST /api/auth/bind-phone` 与 `PATCH /api/users/me`，确认手机号与昵称更新后再次 `GET /api/users/me` 可读到最新值。  
4. 使用不存在用户 token（如 `Bearer mock_token_user_not_exists`）调用 `GET /api/users/me`，确认返回 404 与 `用户不存在`。  
5. 不携带 token 调用 `GET /api/users/me` 或 `GET /api/orders`，确认返回 401 与 `40100/请先登录`。  

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：是（行为级变更，当前用户接口改为强制鉴权）
- 若是：
  - 兼容策略：请求/响应字段结构保持不变，仅将“无 token 回退用户”改为 `40100` 明确拒绝。
  - 调用端同步：小程序调用端已支持 `Authorization` 头，无需代码改动。
  - 文档同步：已更新 `docs/API.md` 与 `docs/API-Schemas.md` 的鉴权说明。

## 风险与后续

- 当前已知风险：
  - token 仍为 mock 方案，仅满足阶段最小登录态需求，未包含签名/过期校验。
- 下一 Stage 建议：
  - 执行 S4（订单落库与事务化），将订单模块从内存 `Map` 迁移到数据库并补齐库存一致性保护。
