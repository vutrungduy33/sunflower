# S3 Stage Report

## 需求确认

- 本 Stage 目标：将认证与用户模块从硬编码内存数据迁移到数据库，覆盖 `/api/auth/wechat/login`、`/api/auth/bind-phone`、`/api/users/me` 的真实读写，并按优先级完成一轮鉴权加固。
- 本 Stage 边界（不做）：不实现 S4 订单落库与事务化；订单模块仍为内存存储，仅复用 S3 的用户登录态解析能力。

## 代码改动

- 主要改动文件：
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/auth/AuthTokenService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/auth/AuthService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/user/UserService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/user/persistence/UserRepository.java`
  - `sunflower-backend/src/main/resources/application.yml`
  - `sunflower-backend/src/main/resources/application-prod.yml`
  - `sunflower-backend/src/test/resources/application-test.yml`
  - `sunflower-backend/src/test/java/com/sunflower/backend/MvpApiIntegrationTests.java`
  - `sunflower-miniapp/utils/mvp/api.js`
  - `docs/API.md`
  - `docs/API-Schemas.md`
- 关键实现点：
  - 新增 `users`、`user_profiles` 的 JPA 实体与仓库，用户信息改为数据库事实源。
  - `AuthService.wechatLogin` 按 `openid` 查找或自动创建用户与资料，返回可解析 `userId` 的 token。
  - `AuthTokenService` 升级为 HMAC-SHA256 签名 token（`payload.signature`），payload 包含 `userId` 与过期时间；支持无效签名与过期校验。
  - `UserService.currentUserId()` 新增“用户必须存在且状态为 ACTIVE”校验，不再接受“token 可解析但用户不存在”场景。
  - `UserService.bindCurrentUserPhone()` 增加数据库唯一约束冲突兜底，`DataIntegrityViolationException` 统一映射为 `409/手机号已被绑定`。
  - `AuthService.registerWechatUser()` 增加并发创建兜底，命中唯一键冲突时回查 `openid` 返回已有用户。
  - 小程序调用端统一默认 HTTPS，并将 `40100-40199` 统一识别为登录态失效，自动清理本地 token。
  - API 文档与 schema 文档同步到“签名+过期 token”语义。
  - 集成测试新增篡改签名与旧 token 格式拒绝用例，并把“不存在用户 token”期望收敛为 `40100/登录态无效`。

## 自动化测试

- 执行命令：
  - `cd sunflower-backend && mvn test -Dtest=MvpApiIntegrationTests`
  - `cd sunflower-backend && mvn test`
- 结果：
  - 两条命令均通过。
  - `MvpApiIntegrationTests`：9/9 通过。
  - 全量测试：12/12 通过。

## 人工复核步骤

1. 启动后端（`dev` 配置），确认数据库中已有 `users` 与 `user_profiles` 数据。  
2. 调用 `POST /api/auth/wechat/login`（如 `code=mvp_code`），记录返回签名 token。  
3. 携带 `Authorization: Bearer <token>` 调用 `POST /api/auth/bind-phone` 与 `PATCH /api/users/me`，确认手机号与昵称更新后再次 `GET /api/users/me` 可读到最新值。  
4. 对 token 进行任意篡改（如在末尾追加字符）后调用 `GET /api/users/me`，确认返回 `40100/登录态无效`。  
5. 使用旧格式 token（如 `Bearer mock_token_user_demo_1001`）或不存在用户 token，调用 `GET /api/users/me`，确认返回 `40100/登录态无效`。  
6. 不携带 token 调用 `GET /api/users/me` 或 `GET /api/orders`，确认返回 `40100/请先登录`。  

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：是（行为级变更，当前用户接口改为强制鉴权）
- 若是：
  - 兼容策略：请求/响应字段结构保持不变；将不安全的“未带 token 回退用户”和“旧 mock token”统一收敛为 `40100`，登录态改为“签名+过期”校验。
  - 调用端同步：已同步 `sunflower-miniapp/utils/mvp/api.js`，对 `40100-40199` 做统一登出兜底并清理 token。
  - 文档同步：已更新 `docs/API.md` 与 `docs/API-Schemas.md` 的鉴权说明与 token 示例。

## 风险与后续

- 当前已知风险：
  - 当前 token 无服务端会话存储，暂不支持主动吊销（仅依赖过期时间）。
  - token secret 轮换策略与多环境密钥托管流程仍需在后续阶段固化。
- 下一 Stage 建议：
  - 执行 S4（订单落库与事务化），将订单模块从内存 `Map` 迁移到数据库并补齐库存一致性保护。
