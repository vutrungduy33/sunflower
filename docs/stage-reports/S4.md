# S4 Stage Report

## 需求确认

- 本 Stage 目标：将 `/api/orders*` 从内存 Map 切换为数据库读写，并在下单/取消流程中引入事务化库存一致性控制。
- 本 Stage 边界（不做）：不实现改期/退款（S6）、不新增管理端订单 API（S8）。

## 代码改动

- 主要改动文件：
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/OrderService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/persistence/OrderEntity.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/persistence/OrderRepository.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/room/persistence/RoomInventoryRepository.java`
  - `sunflower-backend/src/test/java/com/sunflower/backend/MvpApiIntegrationTests.java`
  - `scripts/sql/mvp_demo_seed.sql`
- 关键实现点：
  - `OrderService` 改为基于 `OrderRepository` 持久化，移除内存 `Map` 事实源。
  - 下单/取消使用 `@Transactional`，并通过 `RoomInventoryRepository` 的 `PESSIMISTIC_WRITE` 行锁锁定入住日期库存行。
  - 下单时扣减 `available_stock`、增加 `locked_stock`；取消时反向回补，保证库存守恒。
  - 新增库存不足测试和并发冲突测试，验证“单库存并发下单仅一单成功”。

## 自动化测试

- 执行命令：
  - `cd sunflower-backend && mvn test -Dtest=MvpApiIntegrationTests`
- 结果：
  - 通过（`Tests run: 11, Failures: 0, Errors: 0, Skipped: 0`）

## 人工复核步骤

1. 启动后端并登录两个不同用户，分别获取两个 token。
2. 将同一房型同一日库存设置为 `available_stock=1` 后，使用两个 token 并发调用 `POST /api/orders`，预期一单成功、一单返回 `409`。
3. 对成功订单调用 `POST /api/orders/{id}/pay` 与 `POST /api/orders/{id}/cancel`，并查询 `GET /api/orders/{id}`，预期状态依次流转且取消后库存回补。

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：否
- 兼容策略：保持既有接口路径、请求/响应结构与状态码语义不变。

## 风险与后续

- 当前已知风险：
  - 当前库存并发控制采用数据库行锁，后续高并发场景需结合压测评估锁等待与吞吐。
  - `order_no` 仍为应用侧随机生成，极低概率冲突由重试兜底，后续可评估统一序列号服务。
- 下一 Stage 建议：
  - 执行 `S6`，补齐改期/退款状态机及小程序售后入口。
