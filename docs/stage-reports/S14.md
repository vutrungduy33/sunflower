# S14 Stage Report

## 需求确认

- 本 Stage 目标：将后端部署改为“GitHub Actions 预构建并推送 GHCR 镜像，ECS 只拉取镜像并启动”，缩短 ECS 部署耗时并提升发布稳定性。
- 本 Stage 边界（不做）：不改动业务 API、数据库 schema、小程序/管理端功能；不引入新环境编排平台（如 K8s）。

## 代码改动

- 主要改动文件：
  - `.github/workflows/deploy-backend.yml`
  - `docker-compose.yml`
  - `scripts/start_backend_with_mvp_seed.sh`
  - `docs/CI-CD.md`
  - `docs/Backlog.md`
  - `docs/stage-reports/S14.md`
- 关键实现点：
  - `Deploy Backend To ECS` workflow 新增 `build-and-push` job，使用 Buildx 构建 `sunflower-backend` 镜像并推送到 GHCR（`sha` 标签，`main` 额外推 `latest`）。
  - `deploy` job 增加 `needs: build-and-push`，通过 `BACKEND_IMAGE` 接收本次构建镜像标签，远端登录 GHCR 后部署。
  - 部署 workflow 新增 `GHCR_USERNAME/GHCR_TOKEN` 校验，缺失即失败，避免在 ECS 侧静默退回本地构建。
  - review follow-up：构建 job 固定检出 `main` 并输出 `SOURCE_SHA`；部署时改为 checkout 同一 `SOURCE_SHA`，消除 `workflow_dispatch` 下“分支镜像 + main 脚本”版本错配风险。
  - `docker-compose.yml` 的 `backend` 服务新增 `image: ${BACKEND_IMAGE:-sunflower-backend:local}`，兼容“远端拉镜像 + 本地构建”两种模式。
  - `scripts/start_backend_with_mvp_seed.sh` 增加 `start_backend_service`：当存在 `BACKEND_IMAGE` 时执行 `pull + up`，否则保留 `--build` 回退路径。
  - 同步更新 `docs/CI-CD.md` 的部署流程与 Secrets 说明（补充 GHCR 相关凭据）。

## 自动化测试

- 执行命令：`bash -n scripts/start_backend_with_mvp_seed.sh`
- 结果：通过（脚本语法校验通过）。
- 执行命令：`AUTH_TOKEN_SECRET=dummy BACKEND_IMAGE=ghcr.io/example/sunflower-backend:test docker compose config >/tmp/sunflower.compose.rendered.yml`
- 结果：通过（compose 渲染成功，输出 71 行配置）。
- 执行命令：`cd sunflower-backend && mvn -B test -Dtest=WechatCode2SessionClientTests`
- 结果：通过（`Tests run: 2, Failures: 0, Errors: 0, Skipped: 0`）。
- 执行命令：`./scripts/stage_guard.sh post S14`
- 结果：通过（含 API contract guard 与 Stage 报告结构校验）。

## 人工复核步骤

1. 在 GitHub Secrets 配置 `GHCR_USERNAME` 与 `GHCR_TOKEN`（`read:packages`），并确认仓库 Actions 默认 `GITHUB_TOKEN` 具备 `packages:write`。
2. 触发 `.github/workflows/deploy-backend.yml`（`workflow_dispatch` 或合并到 `main`）。
3. 在 Actions 日志确认 `build-and-push` 已推送 `ghcr.io/<owner>/sunflower-backend:<sha>`。
4. 在 ECS 上执行 `docker images | grep sunflower-backend`，确认存在本次 `sha` 标签镜像。
5. 查看部署日志，确认出现 `Pulling backend image from registry` 且未出现本地 `docker compose ... --build backend` 执行路径。
6. 访问 `http://<ecs-host>:8080/api/health`，确认健康检查通过。

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：否

## 风险与后续

- 当前已知风险：
  - `GHCR_TOKEN` 若过期或权限回收，会导致 ECS 拉镜像失败；需纳入凭据轮换与告警策略。
  - 当前 ECS 仍通过 SSH 拉代码以获取 compose/script；后续可进一步改为“仅分发部署清单 + 镜像”减少远端 Git 依赖。
- 下一 Stage 建议：
  - 执行 S7（管理端后端 API：房型/价格/库存），保持 Backlog 主线推进。
