# S2 Stage Report

## 需求确认

- 本 Stage 目标：将 `/api/rooms`、`/api/rooms/{roomId}`、`/api/rooms/{roomId}/calendar` 的事实源从 `RoomService` 内存硬编码迁移到 MySQL（通过 JPA Repository 读取）。
- 本 Stage 边界（不做）：不实现 S3/S4 的用户与订单持久化重构；订单模块仍维持内存存储，仅复用房型模块提供的数据库查询能力。

## 代码改动

- 主要改动文件：
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/room/RoomService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/room/persistence/RoomEntity.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/room/persistence/RoomPriceEntity.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/room/persistence/RoomInventoryEntity.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/room/persistence/RoomRepository.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/room/persistence/RoomPriceRepository.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/room/persistence/RoomInventoryRepository.java`
  - `sunflower-backend/src/test/java/com/sunflower/backend/MvpApiIntegrationTests.java`
  - `docs/Backlog.md`
- 关键实现点：
  - 新增 `rooms`、`room_prices`、`room_inventory` 对应实体与仓库。
  - 移除 `RoomService` 的 `@PostConstruct` 房型硬编码初始化，改为数据库读取。
  - 房型列表支持按日期批量查询当日价格与库存，详情/日历按日期区间查询价格库存并回填到原有 DTO 结构。
  - 保持原 API 响应结构不变（字段名、层级、成功/失败包裹结构保持一致）。
  - 补充房型参数异常集成测试（非法日期、非法 days 返回 400 与业务错误码）。

## 自动化测试

- 执行命令：
  - `cd sunflower-backend && mvn test -Dtest=MvpApiIntegrationTests`
  - `cd sunflower-backend && mvn test`
- 结果：
  - 两条命令均通过。
  - `MvpApiIntegrationTests`：4/4 通过。
  - 全量测试：7/7 通过。

## 人工复核步骤

1. 启动后端（dev 配置），确认 Flyway 已执行并有 `rooms`/`room_prices`/`room_inventory` 数据。  
2. 调用 `GET /api/rooms?checkInDate=2026-02-12`，确认返回房型列表，且 `todayPrice`、`stock` 与数据库对应日期数据一致。  
3. 调用 `GET /api/rooms/room-lake-101?checkInDate=2026-02-12` 与 `GET /api/rooms/room-lake-101/calendar?startDate=2026-02-12&days=3`，确认详情与日历字段完整，价格库存来自数据库。  
4. 调用 `GET /api/rooms?checkInDate=2026/02/12`，确认返回 400 且 message 为 `日期 格式必须是 yyyy-MM-dd`。  

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：否
- 若是：
  - 兼容策略：不涉及
  - 调用端同步：不涉及
  - 文档同步：不涉及

## 风险与后续

- 当前已知风险：
  - 日历在缺失价格记录时会回退 `basePrice`，缺失库存记录时回退 `0`；若运营端未及时维护日历数据，前端可能看到可售为 0 的日期。
  - `OrderService` 仍为内存事实源（S4 事项），当前仅使用房型模块数据库查询做金额计算。
- 下一 Stage 建议：
  - 执行 S3（用户与认证落库），消除 `DEMO_USER_ID`/内存 profile 事实源。
