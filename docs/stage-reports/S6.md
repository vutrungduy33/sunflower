# S6 Stage Report

## 需求确认

- 本 Stage 目标：实现订单改期与退款售后闭环，覆盖后端 API、订单状态机、库存一致性与小程序订单中心入口。
- 本 Stage 边界（不做）：不实现管理端售后处理能力（S8），不扩展 RBAC 或运营报表，不引入新支付网关逻辑。

## 代码改动

- 主要改动文件：
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/OrderController.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/OrderService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/OrderStatus.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/persistence/OrderEntity.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/dto/OrderDto.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/dto/RescheduleOrderRequest.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/dto/RefundOrderRequest.java`
  - `sunflower-backend/src/main/resources/db/migration/common/V3__add_order_after_sale_fields.sql`
  - `sunflower-backend/src/test/java/com/sunflower/backend/MvpApiIntegrationTests.java`
  - `sunflower-miniapp/utils/mvp/api.js`
  - `sunflower-miniapp/pages/mvp/order-list/index.js`
  - `sunflower-miniapp/pages/mvp/order-list/index.wxml`
  - `sunflower-miniapp/pages/mvp/order-list/index.wxss`
  - `docs/API.md`
  - `docs/API-Schemas.md`
  - `scripts/sql/mvp_demo_seed.sql`
- 关键实现点：
  - 新增 `POST /api/orders/{id}/reschedule`、`POST /api/orders/{id}/refund` 接口，新增 `RESCHEDULED`、`REFUNDED` 状态。
  - 改期实现中先释放原占用库存再锁定新日期库存，失败自动回滚，保证库存一致性。
  - 退款实现释放当前入住区间锁定库存并落库退款状态与时间。
  - 订单 DTO 增加 `cancelledAt/rescheduledAt/refundedAt/afterSaleReason` 字段，保持原字段兼容。
  - 小程序订单中心新增“改期/申请退款”入口，支持顺延 1-3 天改期与退款确认。
  - 更新 API 文档与字段文档，改期/退款从“规划中”升级为“已实现”。

## 自动化测试

- 执行命令：`cd sunflower-backend && mvn test`
- 结果：通过（`Tests run: 19, Failures: 0, Errors: 0, Skipped: 0`）。

## 人工复核步骤

1. 启动后端与小程序，确保小程序已登录且存在 `CONFIRMED` 状态订单。
2. 在订单中心点击“改期”，选择“顺延 1 天/2 天/3 天”任一选项，确认订单状态变为“已改期”，入住离店日期同步变化。
3. 对 `CONFIRMED` 或 `RESCHEDULED` 订单点击“申请退款”，确认后状态变为“已退款”。
4. 在订单筛选栏切换“已改期”“已退款”，确认状态筛选与卡片状态色值一致。
5. （可选）调用 `GET /api/orders/{id}` 校验返回包含 `rescheduledAt/refundedAt/afterSaleReason` 字段。

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：是（新增兼容性接口与新增响应字段）
- 若是：
  - 兼容策略：仅新增接口与可选响应字段，已有接口路径与既有字段不变。
  - 调用端同步：已同步小程序 `order-list` 页面与 `utils/mvp/api.js`。
  - 文档同步：已更新 `docs/API.md` 与 `docs/API-Schemas.md`。

## 风险与后续

- 当前已知风险：改期目前仅支持“保持原入住晚数”模式，未覆盖差价补退逻辑；退款流程为 MVP 同步通过，未接入真实支付网关回调。
- 下一 Stage 建议：执行 S7（管理端后端 API：房型/价格/库存），并为后续 S8 管理端售后处理预留后台查询与操作维度。
