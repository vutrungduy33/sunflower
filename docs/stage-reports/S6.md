# S6 Stage Report

## 需求确认

- 本 Stage 目标：实现订单改期与退款售后闭环，覆盖后端 API、订单状态机、库存一致性与小程序订单中心入口。
- 本 Stage 边界（不做）：不实现管理端售后处理能力（S8），不扩展 RBAC 或运营报表，不引入新支付网关逻辑。
- 2026-02-18 收口补充：在不扩展 S7+ 范围的前提下，完成 M1（S1-S6）集成测试计划、执行与文档一致性校验。

## 代码改动

- 主要改动文件：
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/OrderController.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/OrderService.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/OrderStatus.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/persistence/OrderEntity.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/dto/OrderDto.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/dto/RescheduleOrderRequest.java`
  - `sunflower-backend/src/main/java/com/sunflower/backend/modules/order/dto/RefundOrderRequest.java`
  - `sunflower-backend/src/main/resources/db/migration/common/V3__add_order_after_sale_fields.sql`
  - `sunflower-backend/src/test/java/com/sunflower/backend/MvpApiIntegrationTests.java`
  - `sunflower-miniapp/utils/mvp/api.js`
  - `sunflower-miniapp/pages/mvp/home/index.js`
  - `sunflower-miniapp/pages/mvp/order-list/index.js`
  - `sunflower-miniapp/pages/mvp/order-list/index.wxml`
  - `sunflower-miniapp/pages/mvp/order-list/index.wxss`
  - `docs/API.md`
  - `docs/API-Schemas.md`
  - `docs/M1-Integration-Test-Plan.md`
  - `docs/M1-TC-M1-12-Manual-Checklist.md`
  - `docs/Flows.md`
  - `docs/Miniapp-Frontend-MVP.md`
  - `docs/README.md`
  - `docs/Backlog.md`
  - `docs/stage-reports/S6.md`
  - `scripts/start_backend_with_mvp_seed.sh`
  - `scripts/sql/mvp_demo_seed.sql`
  - `sunflower-backend/src/main/resources/db/migration/dev/V2__seed_dev_data.sql`
  - `sunflower-backend/src/main/resources/db/migration/test/V2__seed_test_data.sql`
- 关键实现点：
  - 新增 `POST /api/orders/{id}/reschedule`、`POST /api/orders/{id}/refund` 接口，新增 `RESCHEDULED`、`REFUNDED` 状态。
  - 改期库存锁改为“单次锁定 old/new 合并日期区间并在同一锁集中释放+占用”，避免并发反向改期时的锁顺序死锁风险。
  - 退款实现释放当前入住区间锁定库存并落库退款状态与时间。
  - 订单 DTO 增加 `cancelledAt/rescheduledAt/refundedAt/afterSaleReason` 字段，保持原字段兼容。
  - 小程序订单中心新增“改期/申请退款”入口，支持顺延 1-3 天改期与退款确认。
  - 小程序首页登录改为“优先复用本地 token”，仅在缺失登录态时调用 `wx.login`，避免重进首页触发 mock 用户切换导致订单丢失。
  - 更新 API 文档与字段文档，改期/退款从“规划中”升级为“已实现”。
  - 新增 `docs/M1-Integration-Test-Plan.md`，输出 M1 需求追踪矩阵、测试用例（步骤/预期）与执行结果。
  - 新增 `docs/M1-TC-M1-12-Manual-Checklist.md`，提供可直接回放的“逐步打勾+截图位”现场验收单。
  - 完成 M1 文档一致性修正：同步 `Flows` 状态机、`Miniapp-Frontend-MVP` 联调现状、`docs/README` 进展基线。
  - 修复部署脚本顺序：先启动 backend 触发 Flyway，再执行 seed，避免 `after_sale_reason/rescheduled_at/refunded_at` 列未迁移时导数失败导致旧版本接口仍为 404。
  - 修复售后库存兼容：当历史数据出现“订单可售后但库存锁已丢失”时，改期/退款改为兼容释放（`lockedStock=0` 视为已释放），避免返回 `409 库存数据异常`。
  - 修复 seed 幂等策略：`mvp_demo_seed.sql` 对已存在 `room_inventory` 仅更新 `total_stock`，不再覆盖 `available_stock/locked_stock`，避免部署时抹掉真实订单锁库存。
  - 扩大测试种子时间区间：`dev/test` 的 `V2` 房态与价格种子由 4 天扩展为连续 30 天，降低回归测试和手工联调受固定日期窗口影响的失败概率。

## 自动化测试

- 执行命令：`cd sunflower-backend && mvn test`
- 结果：通过（`Tests run: 19, Failures: 0, Errors: 0, Skipped: 0`）。
- 执行命令：`cd sunflower-backend && mvn test -Dtest=DatabaseMigrationIntegrationTests,MvpApiIntegrationTests`
- 结果：通过（`Tests run: 16, Failures: 0, Errors: 0, Skipped: 0`）。
- 执行命令：`cd sunflower-backend && mvn test -Dtest=MvpApiIntegrationTests`
- 结果：通过（包含新增“改期重叠区间”回归用例）。
- 执行命令：`cd sunflower-miniapp && node --check utils/mvp/api.js && node --check pages/mvp/home/index.js`
- 结果：通过。
- 执行命令：`./scripts/check_mvp_subpage_nav.sh`
- 结果：通过（`PASS: all non-tab mvp pages contain <mvp-nav-actions>`）。
- 执行命令：`bash -n scripts/start_backend_with_mvp_seed.sh`
- 结果：通过（脚本语法校验通过）。
- 执行命令：`cd sunflower-backend && mvn test -Dtest=MvpApiIntegrationTests#shouldRescheduleAndRefundConfirmedOrder+shouldRescheduleWhenOriginalLockAlreadyReleased+shouldRefundWhenOriginalLockAlreadyReleased`
- 结果：通过（覆盖“锁库存被历史 seed 重置后”的改期/退款回归）。
- 执行命令：`cd sunflower-backend && mvn test -Dtest=DatabaseMigrationIntegrationTests`
- 结果：通过（验证扩大时间区间后的 test profile 迁移与种子可执行）。

## 人工复核步骤

1. 启动后端与小程序，确保小程序已登录且存在 `CONFIRMED` 状态订单。
2. 在订单中心点击“改期”，选择“顺延 1 天/2 天/3 天”任一选项，确认订单状态变为“已改期”，入住离店日期同步变化。
3. 对 `CONFIRMED` 或 `RESCHEDULED` 订单点击“申请退款”，确认后状态变为“已退款”。
4. 在订单筛选栏切换“已改期”“已退款”，确认状态筛选与卡片状态色值一致。
5. （可选）调用 `GET /api/orders/{id}` 校验返回包含 `rescheduledAt/refundedAt/afterSaleReason` 字段。
6. 参照 `docs/M1-Integration-Test-Plan.md` 的 `TC-M1-12`、`TC-M1-13` 执行小程序售后入口与文档一致性回放。
7. 执行 `docs/M1-TC-M1-12-Manual-Checklist.md` 并按步骤补齐截图证据。
8. 在已登录状态下重新进入首页后再进入“订单中心”，确认仍为同一登录用户，订单列表不因首页重登而清空。

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：是（新增兼容性接口与新增响应字段）
- 若是：
  - 兼容策略：仅新增接口与可选响应字段，已有接口路径与既有字段不变。
  - 调用端同步：已同步小程序 `order-list` 页面与 `utils/mvp/api.js`。
  - 文档同步：已更新 `docs/API.md` 与 `docs/API-Schemas.md`。
  - 本次收口补充：未新增 API 契约变化，仅补充测试与文档一致性修正。

## 风险与后续

- 当前已知风险：改期目前仅支持“保持原入住晚数”模式，未覆盖差价补退逻辑；退款流程为 MVP 同步通过，未接入真实支付网关回调。
- 当前已知风险：小程序可视化流程仍依赖手工回放，尚未接入端到端自动化 UI 测试。
- 下一 Stage 建议：执行 S7（管理端后端 API：房型/价格/库存），并为后续 S8 管理端售后处理预留后台查询与操作维度。
