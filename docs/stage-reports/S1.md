# S1 Stage Report

## 需求确认

- 本 Stage 目标：引入 Flyway 迁移机制，建立 `users/user_profiles/rooms/room_prices/room_inventory/orders` 核心表，并提供开发/测试环境初始化数据能力。
- 本 Stage 边界（不做）：不改造业务服务为数据库读写（`S2-S4` 范围），不变更现有 API 契约。

## 代码改动

- 主要改动文件：
  - `sunflower-backend/pom.xml`
  - `sunflower-backend/src/main/resources/application.yml`
  - `sunflower-backend/src/main/resources/application-dev.yml`
  - `sunflower-backend/src/main/resources/application-prod.yml`
  - `sunflower-backend/src/test/resources/application-test.yml`
  - `sunflower-backend/src/main/resources/db/migration/common/V1__create_core_tables.sql`
  - `sunflower-backend/src/main/resources/db/migration/dev/V2__seed_dev_data.sql`
  - `sunflower-backend/src/main/resources/db/migration/test/V2__seed_test_data.sql`
  - `sunflower-backend/src/test/java/com/sunflower/backend/DatabaseMigrationIntegrationTests.java`
- 关键实现点：
  - 新增 Flyway 依赖并启用 profile 级迁移路径：`common`（建表）+ `dev/test`（初始化数据）。
  - 落地 S1 约定核心表结构、索引、唯一约束与外键约束。
  - 为测试环境新增迁移验证集成测试，校验核心表创建与种子数据加载。

## 自动化测试

- 执行命令：`cd sunflower-backend && mvn test`
- 结果：通过（`Tests run: 6, Failures: 0, Errors: 0, Skipped: 0`）。
- 执行命令：`docker compose up -d backend && curl http://127.0.0.1:8080/api/health`
- 结果：通过（返回 `{"code":0,"message":"OK","data":{"status":"UP",...}}`）。

## 人工复核步骤

1. 在仓库根目录执行 `docker compose up -d backend`。
2. 执行 `curl http://127.0.0.1:8080/api/health`，确认返回 `code=0` 且 `data.status=UP`。
3. 执行 `docker exec sunflower-mysql mysql -uroot -proot -e "SELECT version, description, success FROM sunflower.flyway_schema_history ORDER BY installed_rank;"`，确认至少包含 `V1 create core tables` 与 `V2 seed dev data`。
4. 执行 `docker compose stop backend mysql` 回收本地容器资源。

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：否

## 风险与后续

- 当前已知风险：开发机如果同时运行本地 `mysqld`（127.0.0.1:3306）和 Docker MySQL，`dev` 直连校验可能打到本机实例，建议联调优先走 `docker compose` 方式。
- 下一 Stage 建议：执行 S2（房型模块落库，替换 `RoomService` 硬编码数据源）。
