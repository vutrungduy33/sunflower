# S1 Stage Report

## 需求确认

- 本 Stage 目标：引入 Flyway 迁移机制，建立 `users/user_profiles/rooms/room_prices/room_inventory/orders` 核心表，并提供开发/测试环境初始化数据能力。
- 本 Stage 边界（不做）：不改造业务服务为数据库读写（`S2-S4` 范围），不变更现有 API 契约。
- Hotfix（2026-02-12）：修复生产环境 MySQL 启动时 `Unsupported Database: MySQL 8.0` 导致服务无法启动的问题。
- Hotfix（2026-02-13）：新增部署启动脚本，先自动导入 MVP 演示数据再启动 backend，避免空库部署时因缺少事实数据导致服务启动失败。
- Hotfix（2026-02-13）：修复演示数据导入字符集，`mysql` 导入命令显式使用 `utf8mb4`，避免中文入库乱码。

## 代码改动

- 主要改动文件：
  - `sunflower-backend/pom.xml`
  - `sunflower-backend/src/main/resources/application.yml`
  - `sunflower-backend/src/main/resources/application-dev.yml`
  - `sunflower-backend/src/main/resources/application-prod.yml`
  - `sunflower-backend/src/test/resources/application-test.yml`
  - `sunflower-backend/src/main/resources/db/migration/common/V1__create_core_tables.sql`
  - `sunflower-backend/src/main/resources/db/migration/dev/V2__seed_dev_data.sql`
  - `sunflower-backend/src/main/resources/db/migration/test/V2__seed_test_data.sql`
  - `sunflower-backend/src/test/java/com/sunflower/backend/DatabaseMigrationIntegrationTests.java`
  - `scripts/start_backend_with_mvp_seed.sh`
  - `scripts/sql/mvp_demo_seed.sql`
  - `.github/workflows/deploy-backend.yml`
  - `scripts/stage_guard.sh`
  - `docs/Agent-Stage-Plan.md`
  - `docs/Backlog.md`
  - `docs/CI-CD.md`
- 关键实现点：
  - 新增 Flyway 依赖并启用 profile 级迁移路径：`common`（建表）+ `dev/test`（初始化数据）。
  - 落地 S1 约定核心表结构、索引、唯一约束与外键约束。
  - 为测试环境新增迁移验证集成测试，校验核心表创建与种子数据加载。
  - Hotfix：在 `flyway-core` 外补充 `flyway-mysql` 插件依赖，确保 Flyway 可识别 MySQL 数据库类型。
  - Hotfix：新增 `scripts/start_backend_with_mvp_seed.sh`，部署时执行“启动 mysql -> 导入 `scripts/sql/mvp_demo_seed.sql` -> 启动 backend”。
  - Hotfix：导入命令新增 `--default-character-set=utf8mb4`，确保中文演示数据按 UTF-8 正确写入 MySQL。
  - Hotfix：新增 `scripts/sql/mvp_demo_seed.sql`，以幂等方式导入 MVP 演示用户、资料、房型、未来 30 天价格与库存、演示订单。
  - Hotfix：`deploy-backend.yml` 改为调用启动脚本，且将脚本/SQL 变更纳入部署触发路径。
  - Hotfix：`stage_guard.sh post` 新增规则：若变更命中 `db/migration` 或 `persistence`，必须同步更新 `scripts/sql/mvp_demo_seed.sql`。

## 自动化测试

- 执行命令：`cd sunflower-backend && mvn test`
- 结果：通过（`Tests run: 6, Failures: 0, Errors: 0, Skipped: 0`）。
- 执行命令：`docker compose up -d backend && curl http://127.0.0.1:8080/api/health`
- 结果：通过（返回 `{"code":0,"message":"OK","data":{"status":"UP",...}}`）。
- 执行命令：`docker compose up -d --build backend && curl -i http://127.0.0.1:8080/api/health`
- 结果：通过（`HTTP/1.1 200`；Flyway 日志出现 `Database: jdbc:mysql://mysql:3306/sunflower (MySQL 8.0)`，无 `Unsupported Database` 异常）。
- 执行命令：`cd sunflower-backend && mvn test`
- 结果：通过（`Tests run: 11, Failures: 0, Errors: 0, Skipped: 0`）。
- 执行命令：`./scripts/start_backend_with_mvp_seed.sh && curl -i http://127.0.0.1:8080/api/health && curl -i "http://127.0.0.1:8080/api/rooms?checkInDate=2026-02-14"`
- 结果：通过（`/api/health` 与 `/api/rooms` 均 `HTTP/1.1 200`，验证部署链路可自动导入演示数据并完成启动）。
- 执行命令：`./scripts/start_backend_with_mvp_seed.sh && curl -sS "http://127.0.0.1:8080/api/rooms/room-lake-101?checkInDate=2026-02-14" | python3 -c 'import sys,json; print(json.load(sys.stdin)[\"data\"][\"name\"])'`
- 结果：通过（返回 `湖景大床房`，中文无乱码）。

## 人工复核步骤

1. 在仓库根目录执行 `./scripts/start_backend_with_mvp_seed.sh`。
2. 执行 `curl http://127.0.0.1:8080/api/health`，确认返回 `code=0` 且 `data.status=UP`。
3. 执行 `curl "http://127.0.0.1:8080/api/rooms?checkInDate=2026-02-14"`，确认返回房型列表且非空。
4. 执行 `docker exec -i sunflower-mysql mysql --default-character-set=utf8mb4 -uroot -proot sunflower -e "SELECT id FROM users WHERE id='user_demo_1001'; SELECT COUNT(*) AS room_cnt FROM rooms; SELECT COUNT(*) AS price_cnt FROM room_prices; SELECT COUNT(*) AS stock_cnt FROM room_inventory;"`，确认演示数据已入库且字符集导入正确。
5. 执行 `docker compose down` 回收本地容器资源。

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：否

## 风险与后续

- 当前已知风险：`scripts/sql/mvp_demo_seed.sql` 为演示数据事实源，若后续 schema 字段变化但遗漏同步，部署将出现数据不完整风险（已通过 stage guard 规则降低风险）。
- 下一 Stage 建议：执行 S4（订单落库与事务化），并在订单表/状态机字段变更时同步更新 `scripts/sql/mvp_demo_seed.sql`。
