# S5 Stage Report

## 需求确认

- 本 Stage 目标：补齐小程序联调收口能力，统一登录态请求头、全局请求错误处理，并完善关键业务页（订单相关）的可回退导航体验。
- 本 Stage 边界（不做）：不改动后端 API 契约，不引入 S6（改期/退款）能力，不调整管理端功能。

## 代码改动

- 主要改动文件：
  - `sunflower-miniapp/components/mvp-nav-actions/index.js`
  - `sunflower-miniapp/components/mvp-nav-actions/index.json`
  - `sunflower-miniapp/components/mvp-nav-actions/index.wxml`
  - `sunflower-miniapp/components/mvp-nav-actions/index.wxss`
  - `scripts/check_mvp_subpage_nav.sh`
  - `.github/workflows/pr-stage-gate.yml`
  - `sunflower-miniapp/pages/mvp/order-list/index.json`
  - `sunflower-miniapp/pages/mvp/order-list/index.wxml`
  - `sunflower-miniapp/pages/mvp/order-create/index.json`
  - `sunflower-miniapp/pages/mvp/order-create/index.wxml`
  - `sunflower-miniapp/pages/mvp/order-create/index.wxss`
  - `sunflower-miniapp/pages/mvp/order-list/index.js`
  - `sunflower-miniapp/pages/mvp/mine/index.js`
  - `sunflower-miniapp/pages/mvp/room-detail/index.json`
  - `sunflower-miniapp/pages/mvp/room-detail/index.wxml`
  - `sunflower-miniapp/pages/mvp/room-detail/index.wxss`
  - `sunflower-miniapp/utils/mvp/api.js`
- 关键实现点：
  - 新增可复用组件 `mvp-nav-actions`，提供“返回上一页 / 返回首页”双入口；当页面栈不足时自动降级到首页重启路由。
  - `mvp-nav-actions` UI 改为 TDesign `t-button` 承载，减少自绘样式并与小程序整体组件体系保持一致。
  - 将组件接入 `order-list`、`order-create`、`room-detail` 三个非 tab 业务页，避免用户从深层页面无法回退。
  - 在请求层补充登录态 header 注入（`Authorization: Bearer <token>`），并在登录成功后持久化 token。
  - 鉴权请求统一增加 `requireAuth`，本地 token 缺失时在请求发起前直接失败并返回统一提示文案。
  - 在请求层统一处理 401 场景：清理本地 token 并返回明确错误文案，便于页面统一兜底提示。
  - 登录态存储 key 统一为 `mock_token`，并清理旧 `SUNFLOWER_AUTH_TOKEN`，避免人工复核清理 `mock_token` 后仍被旧 key 命中。
  - `mine` 与 `order-list` 页面 catch 分支改为优先展示后端/请求层错误文案，保证鉴权失败有显式提示。
  - 新增 `mvp` 子页面导航守卫脚本，约束所有非 tab 页面必须包含 `<mvp-nav-actions>`，并在 PR Gate 中执行防回归检查。
  - 在 `PR Stage Gate` 新增 `ripgrep` 安装步骤，避免 Runner 环境缺失 `rg` 时导致守卫脚本误失败。

## 自动化测试

- 执行命令：`cd sunflower-backend && mvn test`
- 结果：通过（`Tests run: 6, Failures: 0, Errors: 0, Skipped: 0`）。
- 执行命令：`./scripts/check_mvp_subpage_nav.sh`
- 结果：通过（`PASS: all non-tab mvp pages contain <mvp-nav-actions>`）。

## 人工复核步骤

1. 在微信开发者工具中打开小程序工程并编译。
2. 从“我的”页进入“订单中心”，确认页面顶部可见“返回上一页 / 返回首页”。
3. 在“订单中心”点击“返回上一页”，确认回到来源页；再进入后点击“返回首页”，确认回到 `/pages/mvp/home/index`。
4. 进入“房型详情”与“填写订单”页，确认同样具备上述双入口并可正常跳转。
5. 可选：在开发者工具 Storage 删除 `mock_token` 后，触发任一 `requireAuth` 页面请求（如订单中心/我的页），确认出现“登录态已失效，请重新进入首页”提示且不会无提示失败。

## DoD Checklist

- [x] 范围单一（仅本 Stage）
- [x] 自动化测试已执行并通过
- [x] 人工复核步骤可复现
- [x] Backlog 状态已更新
- [x] `make stage-pre/post` 已通过

## API 契约影响

- 是否变更 API 契约：否

## 风险与后续

- 当前已知风险：当前后端仍为演示用户上下文（`DEMO_USER_ID`），登录态 header 已接入但后端尚未使用该 header 做真实鉴权。
- 下一 Stage 建议：执行 S6（订单改期与退款），基于当前订单中心继续补齐售后入口与状态流转。
