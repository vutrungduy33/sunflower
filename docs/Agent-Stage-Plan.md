# Agent 分阶段开发计划（V1）

> 更新时间：2026-02-12  
> 目标：把当前 MVP 现状推进到可上线的 V1（小程序 + 后端 + Web 管理后台），并确保每个 Stage 可在一次与 Agent 的对话中完成“开发 + 测试 + 文档同步”。

## 1. 当前事实基线（2026-02-12）

- 小程序 MVP 前端已完成主链路（首页/预订/下单/支付模拟/订单中心）。
- 后端 API 已覆盖认证、用户、房型、订单、内容主链路。
- 后端业务数据仍在 service 层内存/种子数据，服务重启会重置。
- Web 管理后台尚未开始开发（仓库暂无独立工程目录）。

## 2. V1 最终开发目标（本轮确认）

V1 完成标准（上线就绪）：

1. 小程序 P0 链路可真实落库（不再依赖硬编码内存数据）。
2. 订单主流程可闭环：创建、支付（可先网关模拟）、取消、改期、退款。
3. Web 管理后台具备最小可运营能力：房型/价格库存管理、订单与售后处理、经营概览。
4. 具备可重复验证能力：后端自动化测试 + 管理后台基础自动化测试 + 联调验收清单。

说明：

- P1/P2（商品、服务订单、社区深度运营等）不作为 V1 阻塞项，在 V1 收口后进入下一轮 Stage。

## 3. Stage 执行规则（强约束）

每个 Stage 必须满足：

1. 单次对话内完成：需求确认 -> 编码 -> 测试 -> 结果回传。
2. 只做一个主题，不跨多个大模块。
3. 保持 API 契约兼容或同步更新调用端。
4. 必须有“可执行测试”与“可人工复核步骤”。
5. Stage 完成后必须更新对应文档（至少 `docs/Backlog.md` 勾选状态）。
6. 若 Stage 涉及“数据迁移/持久化入库”变更（迁移脚本、`persistence` 层、核心事实源入库逻辑），必须同步更新 `scripts/sql/mvp_demo_seed.sql`，并确认 `scripts/start_backend_with_mvp_seed.sh` 仍可自动导入演示数据。

## 4. 对话执行模板（每个 Stage 通用）

建议对 Agent 使用固定指令模板：

```text
请执行 Stage Sx（名称），要求：
1) 完成该 Stage 的代码改动
2) 运行并汇报测试结果
3) 更新文档中的 Stage 状态
4) 列出风险与下一 Stage 建议
```

Agent 回传结果至少包含：

1. 改动文件列表
2. 测试命令与结果
3. 手工验证步骤
4. 未解决风险

执行约束（建议强制）：

1. 开始前运行：`./scripts/stage_guard.sh pre Sx`
2. 完成后更新：`docs/stage-reports/Sx.md`
3. 结束前运行：`./scripts/stage_guard.sh post Sx`
4. 分支命名：`codex/s<stage>-<slug>`（例：`codex/s1-db-migration`）
5. 提交前缀：`[Sx] ...`（例：`[S1] add flyway migration`）
6. 执行 DoD 清单：`docs/Definition-of-Done.md`
7. PR 门禁必须通过：Stage Guard + 自动化测试
8. 涉及“数据迁移/持久化入库”时，`stage_guard post` 必须通过 seed 同步校验（`scripts/sql/mvp_demo_seed.sql`）

## 5. Stage 明细（S0-S14）

### S0（已完成）目标重确认与文档分期

- 目标：统一“当前现状 + V1 目标 + Stage 粒度”。
- 产出：本文件 + PRD/README/Backlog 入口对齐。
- 验收：文档可直接指导后续逐 Stage 执行。

### S1 数据库与迁移底座

- 目标：建立 MySQL 持久化基础能力。
- 开发范围：
  - 引入迁移机制（建议 Flyway）。
  - 建立 P0 核心表迁移脚本（users/user_profiles/rooms/room_prices/room_inventory/orders 等）。
  - 提供开发/测试环境初始化数据脚本。
- 必做测试：
  - `cd sunflower-backend && mvn test`
  - 启动服务后 `GET /api/health` 返回成功。
- 完成标准：项目可在空库自动建表并启动。

### S2 房型模块落库（替换 RoomService 硬编码）

- 目标：`/api/rooms*` 全链路改为数据库读。
- 开发范围：
  - room 实体与 repository。
  - 房型列表、详情、日历价格/库存查询逻辑落库。
  - 保持现有响应结构不变。
- 必做测试：
  - 后端集成测试覆盖房型列表/详情/日历。
  - 关键查询与日期参数异常校验。
- 完成标准：移除房型种子硬编码事实源。

### S3 用户与认证落库（替换 User/Auth 硬编码）

- 目标：登录、资料、手机号绑定改为数据库读写。
- 开发范围：
  - users/user_profiles 持久化。
  - 登录态最小方案（可先 token + userId 解析，不阻塞后续）。
  - `/api/auth/*` 与 `/api/users/me` 改为真实读写。
- 必做测试：
  - 登录、绑手机号、更新资料集成测试。
  - 非法参数与不存在用户场景测试。
- 完成标准：`DEMO_USER_ID` 不再作为事实用户源。

### S4 订单落库与事务化

- 目标：`/api/orders*` 改为数据库读写并保证库存一致性。
- 开发范围：
  - order 实体/repository。
  - 下单扣库存、支付、取消状态流转事务化。
  - 并发下单基础保护（乐观锁或行锁二选一）。
- 必做测试：
  - 创建/支付/取消/查询集成测试。
  - 库存不足与并发冲突测试。
- 完成标准：`OrderService` 内存 Map 不再作为事实源。

### S5 小程序联调收口（鉴权与错误兜底）

- 目标：小程序稳定联调持久化后端。
- 开发范围：
  - 统一请求头携带登录态。
  - 全局错误处理（鉴权失效、参数错误、服务异常）。
  - 关键页面空态/错误态补齐。
- 必做测试：
  - 小程序开发者工具手工走通预订主链路。
  - 后端回归测试全绿。
- 完成标准：前端不依赖本地 mock/store 才可完成主流程。

### S6 订单改期与退款（小程序 + 后端）

- 目标：补齐 P0 售后能力。
- 开发范围：
  - 新增改期/退款 API 与状态机。
  - 小程序订单中心新增改期/退款入口。
  - 状态展示与文案统一。
- 必做测试：
  - 改期/退款接口集成测试。
  - 小程序订单页面手工验证。
- 完成标准：订单售后最小闭环可用。

### S7 管理端后端 API（房型/价格/库存）

- 目标：支持后台管理房态与价格。
- 开发范围：
  - `POST/PATCH /api/admin/rooms`
  - `POST /api/admin/room-prices`
  - `POST /api/admin/room-inventory`
  - 管理端身份校验最小实现。
- 必做测试：
  - 管理接口权限/参数/成功路径集成测试。
- 完成标准：后台可通过 API 完成房型与房态维护。

### S8 管理端后端 API（订单与经营概览）

- 目标：支持后台处理订单与查看核心指标。
- 开发范围：
  - 管理端订单列表/详情/售后处理接口。
  - 经营概览接口（订单数、待入住、退款单、成交额）。
- 必做测试：
  - 管理订单筛选与状态流转测试。
  - 报表统计口径测试（至少 1-2 个核心指标）。
- 完成标准：后台 API 可支撑基础运营看板与订单处理。

### S9 管理后台工程初始化（Web）

- 目标：创建可持续迭代的 Web 工程骨架。
- 开发范围：
  - 新建 `sunflower-admin-web`（建议 React + TypeScript + Vite）。
  - 接入 UI 组件库、路由、HTTP 客户端、环境配置。
  - 建立 `lint/test/build` 脚本。
- 必做测试：
  - `npm run lint`
  - `npm run test`
  - `npm run build`
- 完成标准：Web 项目可本地启动、可构建、可测试。

### S10 管理后台登录与权限骨架

- 目标：后台具备最小登录态与页面守卫。
- 开发范围：
  - 登录页、鉴权拦截、基础布局（侧边菜单 + 顶栏）。
  - 路由守卫与未登录跳转。
- 必做测试：
  - 登录成功/失败单元测试。
  - 路由守卫行为测试。
- 完成标准：未登录不可访问后台业务页。

### S11 管理后台页面（房型管理）

- 目标：后台可维护房型基础信息。
- 开发范围：
  - 房型列表页、创建/编辑弹窗或独立页。
  - 调用 S7 的房型管理 API。
- 必做测试：
  - 表单校验测试。
  - 列表加载与保存成功/失败场景测试。
- 完成标准：房型维护可全流程操作。

### S12 管理后台页面（价格日历与库存）

- 目标：后台可批量维护价格与库存。
- 开发范围：
  - 日期维度批量编辑界面。
  - 调用 S7 价格/库存 API 并展示变更反馈。
- 必做测试：
  - 批量编辑逻辑测试。
  - 至少 1 条端到端冒烟（进入页面 -> 提交 -> 成功提示）。
- 完成标准：运营可独立完成价格与库存调整。

### S13 管理后台页面（订单与售后）

- 目标：后台可处理订单、改期、退款。
- 开发范围：
  - 订单列表筛选、详情抽屉/页面、售后操作按钮。
  - 调用 S8 订单 API。
- 必做测试：
  - 列表筛选与状态流转测试。
  - 售后操作成功/失败场景测试。
- 完成标准：订单运营流程在后台可闭环。

### S14 联调收口、CI 门禁与发布验收

- 目标：形成可发布的 V1 交付包。
- 开发范围：
  - 补齐 CI（后端测试 + Web 测试 + 构建检查）。
  - 产出联调验收清单（小程序 + 后台 + API）。
  - 完成发布说明与回滚说明。
- 必做测试：
  - 全量自动化测试通过。
  - 按验收清单完成 1 轮端到端人工验收。
- 完成标准：满足 V1 上线标准并可灰度发布。

## 6. 里程碑映射（便于管理）

- M1：S1-S6（后端落库 + 小程序主链路稳定 + 售后补齐）
- M2：S7-S13（后台 API + Web 管理后台 MVP）
- M3：S14（联调收口 + CI + 发布）

## 7. 风险前置（执行时持续检查）

1. 支付与退款的真实微信能力可能受资质与联调环境影响，先保证网关抽象与状态机不返工。
2. 后台权限若一步到位 RBAC 成本高，V1 先做最小角色（admin/operator）即可。
3. 小程序自动化测试能力弱，必须保留手工验收 checklist，避免“只测后端不测端上”。
4. 每个 Stage 结束必须同步文档，否则很快失真。
