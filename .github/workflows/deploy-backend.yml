name: Deploy Backend To ECS

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "sunflower-backend/**"
      - "docker-compose.yml"
      - "scripts/start_backend_with_mvp_seed.sh"
      - "scripts/sql/**"
      - ".github/workflows/deploy-backend.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          AUTH_TOKEN_SECRET: ${{ secrets.AUTH_TOKEN_SECRET }}
          AUTH_TOKEN_TTL_SECONDS: ${{ secrets.AUTH_TOKEN_TTL_SECONDS }}
          WECHAT_AUTH_MOCK_ENABLED: ${{ secrets.WECHAT_AUTH_MOCK_ENABLED }}
          WECHAT_APP_ID: ${{ secrets.WECHAT_APP_ID }}
          WECHAT_APP_SECRET: ${{ secrets.WECHAT_APP_SECRET }}
          WECHAT_JSCODE2SESSION_URL: ${{ secrets.WECHAT_JSCODE2SESSION_URL }}
          WECHAT_MOCK_OPENID_PREFIX: ${{ secrets.WECHAT_MOCK_OPENID_PREFIX }}
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          port: ${{ secrets.ECS_PORT }}
          key: ${{ secrets.ECS_SSH_KEY }}
          envs: AUTH_TOKEN_SECRET,AUTH_TOKEN_TTL_SECONDS,WECHAT_AUTH_MOCK_ENABLED,WECHAT_APP_ID,WECHAT_APP_SECRET,WECHAT_JSCODE2SESSION_URL,WECHAT_MOCK_OPENID_PREFIX
          command_timeout: 30m
          script_stop: true
          script: |
            set -euo pipefail
            REPO_URL="https://github.com/vutrungduy33/sunflower.git"
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            AUTH_TOKEN_SECRET="$(printf '%s' "${AUTH_TOKEN_SECRET:-}" | tr -d '\r\n')"
            AUTH_TOKEN_TTL_SECONDS="$(printf '%s' "${AUTH_TOKEN_TTL_SECONDS:-7200}" | tr -d '\r\n')"
            WECHAT_AUTH_MOCK_ENABLED="$(printf '%s' "${WECHAT_AUTH_MOCK_ENABLED:-false}" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')"
            WECHAT_APP_ID="$(printf '%s' "${WECHAT_APP_ID:-}" | tr -d '\r\n')"
            WECHAT_APP_SECRET="$(printf '%s' "${WECHAT_APP_SECRET:-}" | tr -d '\r\n')"
            WECHAT_JSCODE2SESSION_URL="$(printf '%s' "${WECHAT_JSCODE2SESSION_URL:-https://api.weixin.qq.com/sns/jscode2session}" | tr -d '\r\n')"
            WECHAT_MOCK_OPENID_PREFIX="$(printf '%s' "${WECHAT_MOCK_OPENID_PREFIX:-mock_openid_}" | tr -d '\r\n')"

            if [ -z "$AUTH_TOKEN_SECRET" ]; then
              echo "Missing required secret AUTH_TOKEN_SECRET"
              exit 1
            fi
            if [ "$WECHAT_AUTH_MOCK_ENABLED" != "true" ] && [ "$WECHAT_AUTH_MOCK_ENABLED" != "false" ]; then
              echo "Invalid WECHAT_AUTH_MOCK_ENABLED, must be true or false"
              exit 1
            fi
            if [ "$WECHAT_AUTH_MOCK_ENABLED" = "false" ] && { [ -z "$WECHAT_APP_ID" ] || [ -z "$WECHAT_APP_SECRET" ]; }; then
              echo "WECHAT_APP_ID and WECHAT_APP_SECRET are required when WECHAT_AUTH_MOCK_ENABLED=false"
              exit 1
            fi

            export AUTH_TOKEN_SECRET
            export AUTH_TOKEN_TTL_SECONDS
            export WECHAT_AUTH_MOCK_ENABLED
            export WECHAT_APP_ID
            export WECHAT_APP_SECRET
            export WECHAT_JSCODE2SESSION_URL
            export WECHAT_MOCK_OPENID_PREFIX

            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            if [ ! -d .git ]; then
              git clone "$REPO_URL" .
            fi

            git fetch origin main
            git checkout main
            git reset --hard origin/main

            chmod +x scripts/start_backend_with_mvp_seed.sh
            ./scripts/start_backend_with_mvp_seed.sh

            for i in $(seq 1 20); do
              if curl -fsS http://127.0.0.1:8080/api/health >/dev/null; then
                echo "Backend health check passed."
                exit 0
              fi
              sleep 3
            done
            
            echo "Backend health check failed."
            docker logs --tail 200 sunflower-backend || true
            exit 1
