name: Deploy Backend To ECS

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "sunflower-backend/**"
      - "docker-compose.yml"
      - "scripts/start_backend_with_mvp_seed.sh"
      - "scripts/sql/**"
      - ".github/workflows/deploy-backend.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          AUTH_TOKEN_SECRET: ${{ secrets.AUTH_TOKEN_SECRET }}
          AUTH_TOKEN_TTL_SECONDS: ${{ secrets.AUTH_TOKEN_TTL_SECONDS }}
          WECHAT_AUTH_MOCK_ENABLED: ${{ secrets.WECHAT_AUTH_MOCK_ENABLED }}
          WECHAT_APP_ID: ${{ secrets.WECHAT_APP_ID }}
          WECHAT_APP_SECRET: ${{ secrets.WECHAT_APP_SECRET }}
          WECHAT_JSCODE2SESSION_URL: ${{ secrets.WECHAT_JSCODE2SESSION_URL }}
          WECHAT_MOCK_OPENID_PREFIX: ${{ secrets.WECHAT_MOCK_OPENID_PREFIX }}
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          port: ${{ secrets.ECS_PORT }}
          key: ${{ secrets.ECS_SSH_KEY }}
          envs: AUTH_TOKEN_SECRET,AUTH_TOKEN_TTL_SECONDS,WECHAT_AUTH_MOCK_ENABLED,WECHAT_APP_ID,WECHAT_APP_SECRET,WECHAT_JSCODE2SESSION_URL,WECHAT_MOCK_OPENID_PREFIX
          command_timeout: 30m
          script_stop: true
          script: |
            set -u
            echo "[deploy] script start"
            REPO_URL="https://github.com/vutrungduy33/sunflower.git"
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            run_or_exit() {
              "$@"
              status=$?
              if [ $status -ne 0 ]; then
                echo "ERROR: command failed (status=$status): $*"
                exit $status
              fi
            }
            echo "[deploy] helper ready"

            AUTH_TOKEN_SECRET="$(printf '%s' "${AUTH_TOKEN_SECRET:-}" | tr -d '\r\n')"
            echo "[deploy] normalized AUTH_TOKEN_SECRET"
            AUTH_TOKEN_TTL_SECONDS="$(printf '%s' "${AUTH_TOKEN_TTL_SECONDS:-7200}" | tr -d '\r\n')"
            echo "[deploy] normalized AUTH_TOKEN_TTL_SECONDS"
            WECHAT_AUTH_MOCK_ENABLED="$(printf '%s' "${WECHAT_AUTH_MOCK_ENABLED:-false}" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')"
            echo "[deploy] normalized WECHAT_AUTH_MOCK_ENABLED (step1)"
            WECHAT_AUTH_MOCK_ENABLED="$(printf '%s' "$WECHAT_AUTH_MOCK_ENABLED" | tr -d '\"' | tr -d "'")"
            echo "[deploy] normalized WECHAT_AUTH_MOCK_ENABLED (step2)"
            WECHAT_APP_ID="$(printf '%s' "${WECHAT_APP_ID:-}" | tr -d '\r\n')"
            echo "[deploy] normalized WECHAT_APP_ID"
            WECHAT_APP_SECRET="$(printf '%s' "${WECHAT_APP_SECRET:-}" | tr -d '\r\n')"
            echo "[deploy] normalized WECHAT_APP_SECRET"
            WECHAT_JSCODE2SESSION_URL="$(printf '%s' "${WECHAT_JSCODE2SESSION_URL:-https://api.weixin.qq.com/sns/jscode2session}" | tr -d '\r\n')"
            echo "[deploy] normalized WECHAT_JSCODE2SESSION_URL"
            WECHAT_MOCK_OPENID_PREFIX="$(printf '%s' "${WECHAT_MOCK_OPENID_PREFIX:-mock_openid_}" | tr -d '\r\n')"
            echo "[deploy] normalized WECHAT_MOCK_OPENID_PREFIX"

            if [ -z "$AUTH_TOKEN_SECRET" ]; then
              echo "Missing required secret AUTH_TOKEN_SECRET"
              exit 1
            fi
            if [ "$WECHAT_AUTH_MOCK_ENABLED" = "true" ] || [ "$WECHAT_AUTH_MOCK_ENABLED" = "1" ] || [ "$WECHAT_AUTH_MOCK_ENABLED" = "yes" ] || [ "$WECHAT_AUTH_MOCK_ENABLED" = "y" ] || [ "$WECHAT_AUTH_MOCK_ENABLED" = "on" ]; then
              WECHAT_AUTH_MOCK_ENABLED="true"
            elif [ -z "$WECHAT_AUTH_MOCK_ENABLED" ] || [ "$WECHAT_AUTH_MOCK_ENABLED" = "false" ] || [ "$WECHAT_AUTH_MOCK_ENABLED" = "0" ] || [ "$WECHAT_AUTH_MOCK_ENABLED" = "no" ] || [ "$WECHAT_AUTH_MOCK_ENABLED" = "n" ] || [ "$WECHAT_AUTH_MOCK_ENABLED" = "off" ]; then
              WECHAT_AUTH_MOCK_ENABLED="false"
            else
              echo "WARN: invalid WECHAT_AUTH_MOCK_ENABLED='$WECHAT_AUTH_MOCK_ENABLED', fallback to false"
              WECHAT_AUTH_MOCK_ENABLED="false"
            fi

            if [ "$WECHAT_AUTH_MOCK_ENABLED" = "false" ]; then
              if [ -z "$WECHAT_APP_ID" ] || [ -z "$WECHAT_APP_SECRET" ]; then
                echo "WARN: WECHAT_APP_ID/WECHAT_APP_SECRET missing, fallback WECHAT_AUTH_MOCK_ENABLED=true for this deploy"
                WECHAT_AUTH_MOCK_ENABLED="true"
              fi
            fi
            echo "[deploy] secret/env validation completed"

            export AUTH_TOKEN_SECRET
            export AUTH_TOKEN_TTL_SECONDS
            export WECHAT_AUTH_MOCK_ENABLED
            export WECHAT_APP_ID
            export WECHAT_APP_SECRET
            export WECHAT_JSCODE2SESSION_URL
            export WECHAT_MOCK_OPENID_PREFIX
            echo "[deploy] env exported"

            run_or_exit mkdir -p "$DEPLOY_PATH"
            run_or_exit cd "$DEPLOY_PATH"
            echo "[deploy] switched to deploy path"

            if [ ! -d .git ]; then
              run_or_exit git clone "$REPO_URL" .
            fi

            run_or_exit git fetch origin main
            run_or_exit git checkout main
            run_or_exit git reset --hard origin/main
            echo "[deploy] repository synced to origin/main"

            run_or_exit chmod +x scripts/start_backend_with_mvp_seed.sh
            run_or_exit ./scripts/start_backend_with_mvp_seed.sh
            echo "[deploy] backend startup script executed"

            for i in $(seq 1 20); do
              if curl -fsS http://127.0.0.1:8080/api/health >/dev/null; then
                echo "Backend health check passed."
                exit 0
              fi
              sleep 3
            done
            
            echo "Backend health check failed."
            docker logs --tail 200 sunflower-backend || true
            exit 1
